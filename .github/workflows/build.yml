name: Build PDF Sanitizer

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            name: Windows
            artifact: PDF_Forensic_Sanitizer.exe
          - os: macos-latest
            name: Mac
            artifact: PDF_Forensic_Sanitizer
          - os: ubuntu-latest
            name: Linux
            artifact: PDF_Forensic_Sanitizer

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build Application
        run: pyinstaller --onefile --windowed --name "PDF_Forensic_Sanitizer" pdf_sanitizer_full.py

      - name: List output
        run: ls -la dist/
        shell: bash

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PDF_Forensic_Sanitizer_${{ matrix.name }}
          path: dist/${{ matrix.artifact }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: PDF_Forensic_Sanitizer_Windows
          path: ./release/windows/

      - name: Download Mac Artifact
        uses: actions/download-artifact@v4
        with:
          name: PDF_Forensic_Sanitizer_Mac
          path: ./release/mac/

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: PDF_Forensic_Sanitizer_Linux
          path: ./release/linux/

      - name: Prepare Release Files
        run: |
          cd release
          zip -j PDF_Forensic_Sanitizer_Windows.zip windows/*
          zip -j PDF_Forensic_Sanitizer_Mac.zip mac/*
          zip -j PDF_Forensic_Sanitizer_Linux.zip linux/*
          ls -la

      - name: Delete old release
        run: |
          gh release delete latest --yes || true
          git push origin :refs/tags/latest || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: PDF Forensic Sanitizer - Latest Build
          body: |
            ## PDF Forensic Sanitizer

            **Created by Itay Naftali**

            Remove metadata and forensic traces from PDF files.

            ### Downloads
            - **Windows**: `PDF_Forensic_Sanitizer_Windows.zip`
            - **macOS**: `PDF_Forensic_Sanitizer_Mac.zip`
            - **Linux**: `PDF_Forensic_Sanitizer_Linux.zip`

            ### What it removes
            - Author, Creator, Producer metadata
            - Timestamps (reset to 1970-01-01)
            - Timezone information (+02:00)
            - Hebrew language tags /Lang(he)
            - Document ID (UUID)
            - XMP metadata
          files: |
            release/PDF_Forensic_Sanitizer_Windows.zip
            release/PDF_Forensic_Sanitizer_Mac.zip
            release/PDF_Forensic_Sanitizer_Linux.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
